<!DOCTYPE html>
<html>
<head>
    <title>Teste - Sistema de Observa√ß√£o</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .player-info { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .turn-info { background: #e8f4fd; padding: 15px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .roll-result { background: #fff3cd; padding: 10px; margin: 5px 0; border-radius: 5px; }
        .history { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; max-height: 200px; overflow-y: auto; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .room-selector { margin: 20px 0; }
        .room-selector button { background: #28a745; }
        .room-selector button.active { background: #dc3545; }
        .spectator-mode { background: #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≤ Teste - Sistema de Observa√ß√£o de Jogadas</h1>
        
        <div class="room-selector">
            <h3>Selecionar Sala:</h3>
            <button onclick="joinRoom('bronze')" id="btn-bronze">BRONZE (50-1000)</button>
            <button onclick="joinRoom('prata')" id="btn-prata">PRATA (100-3000)</button>
            <button onclick="joinRoom('ouro')" id="btn-ouro">OURO (200-5000)</button>
        </div>

        <div class="player-info">
            <h3>Informa√ß√µes do Jogador</h3>
            <p><strong>ID:</strong> <span id="player-id">Conectando...</span></p>
            <p><strong>Sala:</strong> <span id="current-room">Nenhuma</span></p>
            <p><strong>Jogadores na sala:</strong> <span id="player-count">0</span></p>
        </div>

        <div class="turn-info" id="turn-info">
            Aguardando conex√£o...
        </div>

        <div class="spectator-mode" id="spectator-info" style="display: none;">
            <h4>üîç Modo Espectador Ativo</h4>
            <p>Voc√™ est√° assistindo as jogadas de outros jogadores!</p>
        </div>

        <div>
            <h3>A√ß√µes</h3>
            <button onclick="requestRoll()" id="roll-btn" disabled>üé≤ Lan√ßar Dados</button>
            <button onclick="disconnect()">‚ùå Desconectar</button>
        </div>

        <div class="history">
            <h3>üìú Hist√≥rico de Jogadas</h3>
            <div id="roll-history">Nenhuma jogada ainda...</div>
        </div>

        <div class="history">
            <h3>üì¢ Log de Eventos</h3>
            <div id="event-log">Conectando ao servidor...</div>
        </div>
    </div>

    <script>
        let socket = null;
        let currentRoom = null;
        let playerId = null;
        let rollHistory = [];

        function log(message) {
            const logDiv = document.getElementById('event-log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `[${time}] ${message}<br>` + logDiv.innerHTML;
        }

        function addToHistory(playerIndex, totalPlayers, dice1, dice2, result) {
            const rollText = `Jogador ${playerIndex}/${totalPlayers}: ${dice1} + ${dice2} = ${result}`;
            rollHistory.unshift(rollText);
            if (rollHistory.length > 10) rollHistory.pop();
            
            document.getElementById('roll-history').innerHTML = rollHistory.join('<br>') || 'Nenhuma jogada ainda...';
        }

        function updateTurnInfo(message, isMyTurn) {
            const turnDiv = document.getElementById('turn-info');
            turnDiv.innerHTML = message;
            turnDiv.style.background = isMyTurn ? '#d4edda' : '#e8f4fd';
            
            document.getElementById('roll-btn').disabled = !isMyTurn;
            
            const spectatorDiv = document.getElementById('spectator-info');
            spectatorDiv.style.display = isMyTurn ? 'none' : 'block';
        }

        function connect() {
            if (socket) return;
            
            socket = io();
            playerId = socket.id;
            
            socket.on('connect', () => {
                playerId = socket.id;
                document.getElementById('player-id').textContent = playerId;
                log('‚úÖ Conectado ao servidor!');
            });

            socket.on('room_config', (cfg) => {
                log(`üè† Configura√ß√£o da sala recebida: ${cfg.name}`);
                document.getElementById('current-room').textContent = cfg.name;
            });

            socket.on('players_update', (count) => {
                document.getElementById('player-count').textContent = count;
                log(`üë• Jogadores na sala: ${count}`);
            });

            socket.on('turn_update', (data) => {
                const isMyTurn = data.playerId === socket.id;
                const message = isMyTurn ? 
                    'üü¢ SUA VEZ DE JOGAR!' : 
                    `üü° JOGADOR ${data.playerIndex}/${data.totalPlayers} EST√Å JOGANDO`;
                
                updateTurnInfo(message, isMyTurn);
                log(`üîÑ Turno atualizado: ${message}`);
            });

            socket.on('turn_tick', (data) => {
                if (data.remaining > 0) {
                    log(`‚è∞ Tempo restante: ${data.remaining}s`);
                }
            });

            socket.on('dice_result', (roll) => {
                const result = roll.d1 + roll.d2;
                log(`üé≤ Resultado dos dados: ${roll.d1} + ${roll.d2} = ${result}`);
                
                if (roll.playerIndex && roll.totalPlayers) {
                    addToHistory(roll.playerIndex, roll.totalPlayers, roll.d1, roll.d2, result);
                }
            });

            socket.on('player_rolled', (data) => {
                const isMyRoll = data.playerId === socket.id;
                if (!isMyRoll) {
                    const message = `üîç JOGADOR ${data.playerIndex}/${data.totalPlayers} JOGOU: ${data.dice[0]} + ${data.dice[1]} = ${data.result}`;
                    log(`üëÄ ${message}`);
                    
                    // Destacar visualmente
                    const turnDiv = document.getElementById('turn-info');
                    turnDiv.style.background = '#ffeaa7';
                    turnDiv.innerHTML = message;
                    
                    setTimeout(() => {
                        turnDiv.style.background = '#e8f4fd';
                    }, 3000);
                }
            });

            socket.on('room_full', () => {
                log('‚ùå Sala cheia! Tente outra sala.');
                alert('Sala cheia! Tente outra sala.');
            });

            socket.on('waiting_for_players', () => {
                updateTurnInfo('‚è≥ AGUARDANDO MAIS JOGADORES...', false);
                log('‚è≥ Aguardando mais jogadores...');
            });

            socket.on('no_players_left', () => {
                updateTurnInfo('‚è≥ AGUARDANDO MAIS JOGADORES...', false);
                log('üëã Outros jogadores sa√≠ram da sala');
            });

            socket.on('disconnect', () => {
                log('‚ùå Desconectado do servidor');
                document.getElementById('player-id').textContent = 'Desconectado';
            });
        }

        function joinRoom(room) {
            if (!socket) connect();
            
            currentRoom = room;
            socket.emit('join_room', room);
            log(`üö™ Tentando entrar na sala: ${room.toUpperCase()}`);
            
            // Atualizar bot√µes
            document.querySelectorAll('.room-selector button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${room}`).classList.add('active');
        }

        function requestRoll() {
            if (!socket || !currentRoom) {
                alert('Conecte-se a uma sala primeiro!');
                return;
            }
            
            socket.emit('request_roll');
            log('üé≤ Solicita√ß√£o de lan√ßamento enviada');
            document.getElementById('roll-btn').disabled = true;
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                playerId = null;
                currentRoom = null;
                
                document.getElementById('player-id').textContent = 'Desconectado';
                document.getElementById('current-room').textContent = 'Nenhuma';
                document.getElementById('player-count').textContent = '0';
                updateTurnInfo('Desconectado', false);
                
                document.querySelectorAll('.room-selector button').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
        }

        // Conectar automaticamente ao carregar a p√°gina
        window.onload = () => {
            log('üåê P√°gina carregada. Clique em uma sala para come√ßar!');
        };
    </script>
</body>
</html>